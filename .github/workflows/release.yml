# =============================================================================
# GitHub Actions - Release Automatique
# Cree des releases avec packages Windows/Linux/Docker separes
# =============================================================================

name: Release

on:
  push:
    tags: ['v*']

jobs:
  # ===========================================================================
  # Creation de la release GitHub
  # ===========================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Read CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extraire la section de la version actuelle
            NOTES=$(sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 || cat CHANGELOG.md | head -50)
          else
            NOTES="Release version ${{ steps.get_version.outputs.version }}"
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.get_version.outputs.version }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: AD Web Interface v${{ steps.get_version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Package Windows
  # ===========================================================================
  build-windows:
    name: Build Windows Package
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Windows package
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          PACKAGE_NAME="AD-WebInterface-${VERSION}-Windows"

          mkdir -p dist/${PACKAGE_NAME}

          # Copier les fichiers (exclure fichiers Linux/Docker)
          rsync -av --exclude='.git' \
                    --exclude='*.sh' \
                    --exclude='Dockerfile' \
                    --exclude='docker-compose.yml' \
                    --exclude='docker-entrypoint.sh' \
                    --exclude='.dockerignore' \
                    --exclude='__pycache__' \
                    --exclude='*.pyc' \
                    --exclude='venv' \
                    --exclude='logs' \
                    --exclude='data' \
                    --exclude='.env' \
                    --exclude='dist' \
                    . dist/${PACKAGE_NAME}/

          # Creer le ZIP
          cd dist
          zip -r ${PACKAGE_NAME}.zip ${PACKAGE_NAME}

      - name: Upload Windows package
        uses: softprops/action-gh-release@v1
        with:
          files: dist/AD-WebInterface-${{ needs.create-release.outputs.version }}-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Package Linux
  # ===========================================================================
  build-linux:
    name: Build Linux Package
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Linux package
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          PACKAGE_NAME="AD-WebInterface-${VERSION}-Linux"

          mkdir -p dist/${PACKAGE_NAME}

          # Copier les fichiers (exclure fichiers Windows)
          rsync -av --exclude='.git' \
                    --exclude='*.bat' \
                    --exclude='*.vbs' \
                    --exclude='*.ps1' \
                    --exclude='*.exe' \
                    --exclude='__pycache__' \
                    --exclude='*.pyc' \
                    --exclude='venv' \
                    --exclude='logs' \
                    --exclude='data' \
                    --exclude='.env' \
                    --exclude='dist' \
                    . dist/${PACKAGE_NAME}/

          # Rendre les scripts executables
          chmod +x dist/${PACKAGE_NAME}/*.sh 2>/dev/null || true
          chmod +x dist/${PACKAGE_NAME}/docker-entrypoint.sh 2>/dev/null || true

          # Creer le tar.gz
          cd dist
          tar -czvf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}

      - name: Upload Linux package
        uses: softprops/action-gh-release@v1
        with:
          files: dist/AD-WebInterface-${{ needs.create-release.outputs.version }}-Linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Package Docker (info seulement)
  # ===========================================================================
  docker-info:
    name: Docker Image Info
    runs-on: ubuntu-latest
    needs: [create-release, build-windows, build-linux]

    steps:
      - name: Add Docker instructions to release
        uses: softprops/action-gh-release@v1
        with:
          append_body: true
          body: |

            ---

            ## Docker

            ```bash
            # Telecharger l'image
            docker pull ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}

            # Ou utiliser latest
            docker pull ghcr.io/${{ github.repository }}:latest

            # Demarrer avec docker-compose
            docker-compose up -d
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
